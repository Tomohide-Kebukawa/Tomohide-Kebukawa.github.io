<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Kebu's Laboratory : Github Actionsでサイトマップを作成するときのメモ</title>
<link href="../css/main.css" rel="stylesheet">
</head> 
<body>

<header>
<h1>Kebu's Laboratory</h1>
<h2>Github Actionsでサイトマップを作成するときのメモ &#x1f44d;</h2>
</header>

<section>
<h2>GitHubのページをGoogle検索でリストさせる</h2>
<p>
GitHubで公開したリポジトリを他の人に利用してもらうためには、やはりGoogleの検索結果に表示されないと不便です。
URLを説明するよりも、確実に検索でヒットするキーワードを教えるほうが、ずっと楽だし、相手も簡単に覚えられるかです。
しかし、ただ単にリポジトリを公開するだけでは、いつまでたっても検索結果にはでてきません。
</p>
<p>
Googleの検索結果に表示されるようにするためには、Googleにリポジトリをクロールして貰う必要があります。
そのためには、次のことをしなければなりません。
<ol>
<li>サイトマップを用意する</li>
<li>Google Search Consoleに登録する</li>
</ol>
</p>
</section>

<section>
<h2>sitemapの作成</h2>
<p>
sitemapは、Googleで検索される公開サイトには必須のものです。
ですが、手作業で作成していると、つい更新がおろそかになり、Google Botが正しくクロールしてくれなくなります。
</p>
<p>
GitHubには、GitHub Actionsという機能があるので、これを使えばページ更新（コミット）したときに自動でサイトマップを作れるに違いないと思いました。
</p>
<ul><li>参考資料：<a href="https://docs.github.com/ja/actions">GitHub Actionsのドキュメント</a></li></ul>
<p>
しかし、Github初心者にはゼロから作るには、ハードルが高すぎです。
</p>
<p>
動作するサンプルコードがあれば、サイトマップの作成を例にして、GitHubアクションを学べるに違いないのです。
一石二鳥というわけです。
</p>
<p>
このような機能は、きっと優秀な先人たちが既に用意しているはずです。
実際ネットを漁ると、色々と情報が出てきますが、そのまま使えるコードがなかなか見つかりません。
</p>
<p>
色々なサイトからコードをコピーしては試してみましたが、なかなか動作しそうにありません。
そんな中、Marketplaceにきちんと説明された、完璧な見本を発見しました。
それが⇓これです！
</p>
<ul><li><a href="https://github.com/marketplace/actions/generate-sitemap">Marketplace / Actions / generate-sitemap</a></li></ul>
<p>
説明をみると、何かをインストールすることなく動作しそうです。
</p>
<p>
ということで、上記のページで公開されている<a href="https://github.com/marketplace/actions/generate-sitemap#example-1-minimal-example">Example 1: Minimal Example</a>をそのまま配置してみました。
</p>
</section>

<section>
<h2>GitHub Actionsの利用</h2>
<p>
見つけたサンプルコードは、どこに書けば良いのかまではgenerate-sitemapの説明では、はっきりと書かれていません。
こういったところが初心者にはきついところだったりしますが、ヒントはあります。
<ul>
<li>GitHub Actionsの<a href="https://docs.github.com/ja/actions/learn-github-actions/understanding-github-actions#workflows">Workflowsの説明</a></li>
<li>generate-sitemapのページの<a href="https://github.com/marketplace/actions/generate-sitemap#real-examples-from-projects-using-the-action">Real Examples From Projects Using the Action</a>で示されている実際のファイル<a href="https://github.com/cicirello/cicirello.github.io/blob/staging/.github/workflows/sitemap-generation.yml">sitemap-generation.yml</a></li>
</ul>
</p>
<p>
簡単に言えば・・・
<ul>
<li>GitHub Actionsのプログラムはワークフローとしてファイルを置くことで、イベントを受け取って動作する</li>
<li>ファイルの拡張子は.yml</li>
<li>ファイルの名前は何でも良い</li>
<li>ファイルの置き場所は基本的にリポジトリ内の.github/workflowsディレクトリに置く</li>
</p>
<p>
サイトマップを作成するワークフローのファイルを.github/workflowsディレクトリ内に置いて、あとはコミットをすればサイトマップができるはずです。
ということで、早速実験しました。
</p>
</section>

<section>
<h2>エラーが出た</h2>
<p>
実際コミットしてためしてみました。
しかし、sitemap.xmlは生成されませんでした。
これまで、他のコードでもうまく行かなかったので、驚きもしませんでしたが少しがっかりです。
</p>
<p>
念のためActionsタグをクリックして、Actionsの履歴を確認しました。
<img class="reference" src="actions_tag.png" />
</p>
<p>
すると、エラーが出ていました。
<img class="reference" src="error.png" />
</p>
<p>
これまでのコードとは感触の違うエラーです。
内容を確認してみると…
</p>
<pre>
	if [[ `git status --porcelain sitemap.xml` ]]; then
		git config --global user.name 'github-actions'
		git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
		git add sitemap.xml
		git commit -m "Automated sitemap update" sitemap.xml
		git push
	fi
shell: /usr/bin/bash -e {0}
[main 43381b1] Automated sitemap update
 1 file changed, 7 insertions(+)
 create mode 100644 sitemap.xml
remote: Permission to Tomohide-Kebukawa/Tomohide-Kebukawa.github.io.git denied to github-actions[bot].
fatal: unable to access 'https://github.com/Tomohide-Kebukawa/Tomohide-Kebukawa.github.io/': The requested URL returned error: 403
Error: Process completed with exit code 128.
</pre>
<p>
コード自体は正しく動作してXMLを生成できているようですが、git pushで失敗しているのが原因のようです。
原因は、どうやらアクセス権にあるようです。
アクションで書き換える権利が不足している可能性があります。
</p>
</section>

<section>
<h2>アクセス権の変更</h2>
<p>
Settingsタグを押し、さらに左端にあるActions / General のリンクを押して設定を確認すると、最後の方にあるWorkflow permissionsカテゴリにそれっぽい設定がありました。
デフォルトでは「Read repository contents and packages permissions」オプションが有効にされていますが説明を読むと、このオプションではワークフローは読み取り権限しかありません。
これだと、git pushで書き換えに失敗すると思います。
</p>
<p>
ということで「Read and write permissions」オプションを有効にして、ワークフローに書き換えを許可することにします。
</p>
</section>

<section>
<h2>生成されました</h2>
<p>
アクセス権を変更したので、早速コンテンツの一部を書き換えて、コミットしてみました。
今度はエラーは解消され、結果、sitemap.xmlは自動で生成されるようになりました。
これでサイトマップの更新については手放しで、コンテンツの作成に没頭することができるようになりました。
</p>
<p>
めでたし、めでたし&#x270c;
</p>
</section>

<footer>
</footer>
</body>
</html>